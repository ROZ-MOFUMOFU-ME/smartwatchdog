## 1. 概要
このツールは、**Googleスプレッドシート**と**Slack**を使用してサーバーの状態を監視し、状態に変化があった場合にSlackに通知を送信します。

## 2. 操作手順
### 2.1 必要なもの
- **Googleアカウント**（Googleスプレッドシートの利用に必要）
- **Slackアカウント**（ステータス通知の受け取りに必要）
- **監視したいサーバー名とサーバーURL**（サーバー名を指定しない場合はサーバーURLのみ使用します）
### 2.2 スプレッドシートの設定
- **A列**にサーバー名（任意）、**B列**にサーバーURL（必須）を入力します。
**例**:

| サーバー名 | サーバーURL |サーバーステータス  |最終更新日時  |
| --- | --- | --- | --- |
| ExampleServer1 | https://example1.com |  |  |
| ExampleServer2 | https://example2.com |  |  |

### 2.3 スプレッドシートの更新
- サーバーの監視は一定間隔で自動で行われ、サーバーステータスに変化があった場合のみ**C列**にサーバーステータス、**D列**に最終更新日時が更新されます。
**例**:

| サーバー名 | サーバーURL |サーバーステータス  |最終更新日時  |
| --- | --- | --- | --- |
| ExampleServer1 | https://example1.com | OK Status:200 | 2024-10-17 03:53:52 UTC+0900 (JST) |
| ExampleServer2 | https://example2.com | ERROR! Status:404 | 2024-10-17 03:53:52 UTC+0900 (JST) |
### 2.4 Slackでの通知確認
- サーバーのステータスに変化があった場合(エラーになったときや正常状態に戻ったとき)Slackに通知が届きます。
- 通知内容には、次の情報が含まれます：
  - サーバー名
  - サーバーURL
  - サーバーステータス（OK、ERRORなど）
  - 最終更新日時
  - スプレッドシートへのリンクボタン（詳細確認用）

## 3. 管理者向けの設定概要
管理者がGoogle Sheets APIとAWS Lambda環境変数とSlackアプリをセットアップしてGoogleスプレッドシートと連携します。
### 3.1 Google Sheets APIとスプレッドシートの準備
#### 3.1.1 Google Sheets APIの設定
1. **Google Sheets API**を有効にします。
1. **Googleサービスアカウント**を作成して認証情報のJSONファイルを保存します。
#### 3.1.2 Googleスプレッドシートの設定
1. **Googleスプレッドシートを新規作成**します。
1. 必要に応じてシートの追加やシート名を設定します。
### 3.2 Lambda環境変数の設定
AWS Lambdaでの動作には、いくつかの環境変数の設定が必要になります。
1. **AWS Lambdaの関数ページ**に移動します。
1. 下にスクロールし、**「環境変数」**セクションを見つけます。
1. **以下の環境変数を設定**します。
      - **キー**: `GOOGLE_CLIENT_EMAIL`
          - **値**: Googleサービスアカウントのクライアントメールアドレス
      - **キー**: `GOOGLE_PRIVATE_KEY`
          - **値**: Googleサービスアカウントのプライベートキー
      - **キー**: `SPREADSHEET_ID`
          - **値**: スプレッドシートのID（URLから取得）
            - 例: `https://docs.google.com/spreadsheets/d/1A2B3C4D5E6F7G8H9I0J/edit` の場合、`1A2B3C4D5E6F7G8H9I0J`がIDになります。
      - **キー**: `RANGE`
          - **値**: スプレッドシートのデータ範囲（例：`A2:D`）
              - シート名を指定した場合は、指定したシートのみが監視対象になります。（例：`シート1!A2:D`）
      - **キー**: `SLACK_WEBHOOK_URL`
          - **値**: SlackのWebhook URL（Slackから取得）
      - **キー**: `S3_BUCKET_NAME`
          - **値**: Amazon S3のバケット名
### 3.3 Slack Webhook URLの取得方法
1. **Slackにログイン**し、通知を受け取りたいチャンネルに移動します。
1. **「アプリの追加」**から**「Incoming Webhooks」**を検索して追加します。
1. Webhook URLを発行し、コピーします。
1. そのURLを**AWS Lambdaの環境変数** `SLACK_WEBHOOK_URL`に設定します。
### 3.4 環境変数の保存
- すべての環境変数を入力し終わったら、**「保存」**ボタンを押して変更を保存します。
### 3.5 監視間隔の設定
- トリガーでイベントスケジュールを設定し、監視間隔を設定します。

## 4. ツールの動作
- スプレッドシートに**A列（サーバー名）**と**B列（サーバーURL）**を入力するだけで、サーバーステータスの監視が開始されます。
- 一定間隔でサーバーを監視し、サーバーステータスの変化があると、**Slackに自動で通知**が送信され、スプレッドシートの**C列（サーバーステータス）**と**D列（最終更新日時）**も更新されます。
- Slack通知のボタンからスプレッドシートで詳細を確認できます。
- 監視対象から外す場合は、**A列（サーバー名）**と**B列（サーバーURL）**を**削除**してください。
- 管理者はAWS Lambdaの環境変数をやAmazon EventBridgeのルールを必要に応じて設定してください。

## 5. 詳細について
詳細な仕様や手順は[GoogleスプレッドシートとAWS Lambdaでサーバーレスなサーバー死活監視ツール"SheetsWatchdog"手順書](https://digital-region.docbase.io/posts/3529871)を参照してください。

## 6. ライセンス

このプロジェクトはMITライセンスの下で提供されています。
